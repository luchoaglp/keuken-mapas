<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Coordenadas por vendedor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
  integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
  crossorigin="" rel="stylesheet"/>
    <!-- Font Awesome -->
    <link href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" rel="stylesheet">
    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- Material Design Bootstrap -->
    <link href="css/mdb.min.css" rel="stylesheet">
    <style>
        #map {
            height: 500px;
        }
    </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg navbar-dark primary-color mb-3">
      <a class="navbar-brand" href="./">Coordenadas para un vendedor espec√≠fico</a>
  </nav>

  <div class="container-fluid">
    
    <div class="row">
      <div class="col-md-2">
        <div class="form-group">
          <label for="from">Desde</label>
          <input type="date" id="from" class="form-control">
        </div>
      </div>
      <div class="col-md-2">
        <div class="form-group">
          <label for="to">Hasta</label>
          <input type="date" id="to" class="form-control">
        </div>
      </div>
      <div class="col-md-3">
        <label for="to">Vendedor</label>
        <select class="mdb-select md-form" id="seller-select">
          <option value="" disabled selected>Seleccionar vendedor</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="to">Tipo de mapa</label>
        <select class="mdb-select md-form" id="map-select">
          <option value="" disabled selected>Seleccionar mapa</option>
          <option value="0">OpenStreetMap Mapnick</option>
          <option value="1">Esri WorldImagery</option>
        </select>
      </div>
      <div class="col-md-2"><br>
        <button type="button" id="btn-submit" class="btn btn-primary">Consultar</button>
      </div>
    </div>
    <hr>
    <div class="row mb-5">
      <div class="col-md-8">
        <div class="card">
          <div class="card-body">
            <div id="map"></div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-body">
            <ul class="list-group">
              <li class="list-group-item d-flex justify-content-between align-items-center">
                  Vendedor: <span id="seller"></span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                  Desde: <span id="from-selected"></span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                  Hasta: <span id="to-selected"></span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<!-- Bootstrap tooltips -->
<script src="js/popper.min.js"></script>
<!-- Bootstrap core JavaScript -->
<script src="js/bootstrap.min.js"></script>
<!-- MDB core JavaScript -->
<script src="js/mdb.min.js"></script>
<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
  integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
  crossorigin=""></script>
<script src="js/usersforenterprise.js"></script>
<script src="js/tilesLayer.js"></script>
<script src="js/moment.min.js"></script>

<script>
$(function() {

  const params = new URLSearchParams(window.location.search);

  if(params.has('enterprise')) {

    // $.getJSON(`http://keu.webhop.org:8991/getusersforenterprise?enterprise=${enterprise}&tracking=1`, { })
    $.getJSON(`./js/sellers.json`, { })
        .done(function(data) {

            sellers = data;

            $('.mdb-select').materialSelect();

            Date.prototype.toDateInputValue = (function() {
                var local = new Date(this);
                local.setMinutes(this.getMinutes() - this.getTimezoneOffset());
                return local.toJSON().slice(0, 10);
            });

            const today = new Date().toDateInputValue();

            $from = $('#from');
            $to = $('#to');
            $sellerSelect = $('#seller-select');
            $mapSelect = $('#map-select');
            $btnSubmit = $('#btn-submit');
            $seller = $('#seller');
            $fromSelected = $('#from-selected');
            $toSelected = $('#to-selected');
            let from;
            let to;
            let seller;
            let sellerName;

            let mapLayerIndex = 0;
            const zoom = 20;
            const map = L.map('map');

            tilesLayer[mapLayerIndex].addTo(map);

            $from.val(today);
            $to.val(today);

            let layerIcons;
            let markers = [];
            
            const enterprise = parseInt(params.get('enterprise'));

            sellers.forEach(seller => {
                $sellerSelect.append(`<option value="${seller.id}">${seller.name}</option>`);
            });

            function reset() {
                markers = [];
                if(layerIcons) {
                  map.removeLayer(layerIcons);
                }
            }

            $from.change(function() {
                reset();
                from = $(this).val();
                $fromSelected.text(from);
            });

            $to.change(function() {
                reset();
                to = $(this).val();
                $toSelected.text(to);
            });

            $sellerSelect.change(function() {
                reset();
                const $sellerSelected = $sellerSelect.find(':selected');
                seller = $sellerSelected.val();
                sellerName = $sellerSelected.text();
                $seller.text(sellerName);
            });

            $mapSelect.change(function() {
                map.removeLayer(tilesLayer[mapLayerIndex]);
                mapLayerIndex = parseInt($(this).find(':selected').val());
                tilesLayer[mapLayerIndex].addTo(map);
            });

            $btnSubmit.click(function() {
                
                seller = $sellerSelect.val();
                
                if(seller !== null) {
                    
                    // $.getJSON(`http://keu.webhop.org:8991/gettracksforseller?enterprise=${enterprise}&seller=${seller}&fromdate=${from}&untildate=${to}`, { })
                    $.getJSON(`./js/seller105.json`, { })

                        .done(tracks => { 

                            let minLat = -Infinity;
                            let minLon = -Infinity;
                            let maxLat = Infinity;
                            let maxLon = Infinity;

                            tracks.forEach(track => {

                                const latOrder = parseFloat(track.latitud_order);
                                const lonOrder = parseFloat(track.longitud_order);

                                minLat = latOrder > minLat ? latOrder : minLat;
                                minLon = lonOrder > minLon ? lonOrder : minLon;
                                maxLat = latOrder < maxLat ? latOrder : maxLat;
                                maxLon = lonOrder < maxLon ? lonOrder : maxLon;

                                const iconOrder = L.icon({
                                    iconUrl: './img/redMarker.svg',
                                    iconSize: [25, 25],
                                    iconAnchor: [13, 20],
                                    popupAnchor: [0, -29]
                                });

                                const desc = `<h5></h5>
                                    <p>${ moment(track.date).format('DD/MM/YYYY, hh:mm:ss')} 
                                    <p>Lat: ${latOrder}, Lon: ${lonOrder}</p>`;

                                const markerOrder = L.marker([latOrder, lonOrder], { icon: iconOrder });
                                markerOrder.bindPopup(desc);
                                markers.push(markerOrder);
                            });

                            layerIcons = L.layerGroup(markers);
                            layerIcons.addTo(map);

                            const distMaxMin = L.latLng(maxLat, maxLon).distanceTo(L.latLng(minLat, minLon));
                            
                            map.setView([(maxLat + minLat) / 2, (maxLon + minLon) / 2], zoom);
                        
                        })
                        .fail((jqxhr, textStatus, error) => {
                            const err = textStatus + ", " + error;
                            console.log("Request Failed: " + err);
                        });

                        /*
                        map.on('click', function(e){
                            var coord = e.latlng;
                            var lat = coord.lat;
                            var lng = coord.lng;
                            console.log(lat + ", " + lng);
                        });
                        */
                }
            });

    }).fail((jqxhr, textStatus, error) => {
        const err = textStatus + ", " + error;
        console.log("Request Failed: " + err);
    });

  }
});
</script>
</body>
</html>